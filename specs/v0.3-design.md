# OrivusJS v0.3 Design Spec: Relations Engine

This document outlines the architectural design for implementing Database Relations in OrivusJS.

## 1. The Problem
Currently, OrivusJS treats every module as an isolated island. To link data (e.g. `User` and `Post`), developers must manually:
1.  Add `authorId` string fields.
2.  Edit `schema.prisma` manually to add `@relation`.
3.  Manually handle strict typing updates.

## 2. The Solution: "Relation" Field Type
We introduce a new field type: `"relation"`. This allows the Spec to fully describe the entity graph.

### JSON Syntax Proposal

#### Spec 1: User (The "One" side)
```json
{
  "name": "user",
  "models": {
    "User": {
        "name": { "type": "string" },
        "posts": { 
            "type": "relation", 
            "target": "Post", 
            "relationType": "hasMany" 
        }
    }
  }
}
```

#### Spec 2: Post (The "Many" side)
```json
{
  "name": "post",
  "models": {
    "Post": {
        "title": { "type": "string" },
        // Simple definition:
        "author": { 
            "type": "relation", 
            "target": "User", 
            "relationType": "belongsTo" 
        }
    }
  }
}
```

## 3. Implementation Strategy

### Phase 1: Spec Parser Update
- Update `ModuleSpec` interface in `src/orivus/core/module-spec.ts`.
- Add validation logic to ensure `target` models exist (or at least provide warnings if they are in another file).

### Phase 2: Prisma Generator Logic (`prisma-model.template.ts`)
The generator must be smart enough to translate the JSON above into valid Prisma code.

**Input (JSON):**
`"author": { "type": "relation", "target": "User", "relationType": "belongsTo" }`

**Output (Prisma):**
```prisma
model Post {
  // ... other fields
  author    User   @relation(fields: [authorId], references: [id])
  authorId  String // Field auto-generated by OrivusJS logic
}
```
*Note: We must strictly assume the target PK is `id`. For v0.3, this convention is acceptable.*

### Phase 3: Zod Schema & Circular Dependencies (`schema.template.ts`)
Zod schemas cannot easily reference each other if they are in different files without circular import errors.

**Strategy:**
For v0.3, we will **NOT** include the relation object in the default Zod Schema.
- `PostSchema` will contain `authorId` (String).
- It will NOT contain `author` (User object) by default to avoid cycles.
- We might generate a separate `PostWithRelationsSchema` using `z.lazy()` in the future, but for now, we keep validation strictly to *fields*.

### Phase 4: Service Layer (`service.template.ts`)
The service create/list actions need to be aware of relations.

- **Create**: Input will accept `authorId`. Prisma handles the connection.
- **List**: We need to decide if we `include` relations by default.
    - *Decision*: By default, **NO**. Keep it performant.
    - *Feature*: Add a query param `with: ["author"]` in the future.

## 4. Todo List
- [ ] Update `src/orivus/core/module-spec.ts` types.
- [ ] Update `src/orivus/generator/templates/prisma-model.template.ts` to handle `belongsTo` (generate FK field) and `hasMany`.
- [ ] Test with a multi-module generation (User + Post).
