# ğŸ”§ OrivusJS v0.4.3 - Stability Release Plan

> **Goal**: Make the framework "just work" for common use cases before adding advanced features.
>
> **Principle**: *"A framework that fails on a simple blog cannot promise AI-Native capabilities."*

---

## ğŸ“‹ Executive Summary

### Current State (v0.4.2)
- Templates have silent bugs that only surface at runtime
- Relation handling is fragile (hasMany, belongsTo, FK detection)
- No automated validation of generated code
- Error messages are cryptic (Prisma/tRPC stack traces)
- No test coverage for the generation pipeline itself

### Target State (v0.4.3)
- Blog Platform generates with **zero manual intervention**
- Template bugs caught by automated tests before release
- Spec validation catches errors before generation
- Clear, actionable error messages
- E2E test proves the pipeline works

---

## ğŸ¯ Success Criteria

### Must Pass Before Release:
```bash
npm run orivus:e2e-test specs/products/blog
# Expected output:
# âœ… Spec validation passed (4 modules)
# âœ… Generation completed (16 files)
# âœ… Prisma schema valid
# âœ… TypeScript compilation passed
# âœ… All tests passed (4/4)
# âœ… Blog Platform ready at http://localhost:3000
```

---

## ğŸ“¦ Deliverables

### 1. Template Test Suite
**Priority**: ğŸ”´ CRITICAL
**Files**: `tests/templates/*.test.ts`

Test every template in isolation:

| Template | Critical Tests |
|----------|---------------|
| `prisma-model.template` | Skips hasMany when target doesn't exist |
| `prisma-model.template` | Generates belongsTo with FK correctly |
| `prisma-model.template` | Skips manyToMany (not yet supported) |
| `schema.template` | Uses nullish() for optional fields |
| `schema.template` | Generates FK fields for belongsTo |
| `router.template` | Infers mutation vs query correctly |
| `router.template` | Generates input validation for all field types |
| `service.template` | Maps create/list/update/delete correctly |
| `test.template` | Passes {} for actions with optional input |
| `ui-form.template` | Detects *Id fields as relation selects |
| `ui-list.template` | Passes {} for actions with optional input |

### 2. Spec Validator
**Priority**: ğŸ”´ CRITICAL
**Files**: `src/orivus/core/spec-validator.ts`

Validate specs BEFORE generation:

```typescript
interface ValidationResult {
    valid: boolean;
    errors: ValidationError[];
    warnings: ValidationWarning[];
}

interface ValidationError {
    code: string;
    message: string;
    path: string;  // e.g., "models.Post.author.target"
    suggestion?: string;
}
```

**Validations to implement**:
- [ ] Required fields present (name, models, actions)
- [ ] Model names are PascalCase
- [ ] Action names are camelCase
- [ ] Field types are valid (string, number, boolean, date, json, relation)
- [ ] Relation targets exist in the same spec OR warn if external
- [ ] Actions reference existing models
- [ ] No duplicate field names
- [ ] No circular dependencies (for future)

### 3. CLI Error Improvements
**Priority**: ğŸŸ¡ HIGH
**Files**: `src/orivus/cli/create-module.ts`

Replace cryptic errors with actionable messages:

| Before | After |
|--------|-------|
| `P1012: Type "Post" is neither a built-in type...` | `âŒ ORIVUS: Model "Post" not found. Generate it first or check spelling.` |
| `TRPCError: Output validation failed` | `âŒ ORIVUS: Schema mismatch. Check that schema.template handles nullable fields.` |
| `ENOENT: no such file or directory` | `âŒ ORIVUS: File not found after generation. Try clearing .next cache.` |

### 4. E2E Generation Test
**Priority**: ğŸŸ¡ HIGH
**Files**: `src/orivus/cli/e2e-test.ts`

Command: `npm run orivus:e2e-test <product-path>`

Steps:
1. Read `_manifest.json` from product folder
2. Validate all specs
3. Generate modules in order
4. Run `prisma db push`
5. Run `tsc --noEmit` (type check)
6. Run `npm run test` (unit tests)
7. Report results with timing

### 5. updatePrisma Improvements
**Priority**: ğŸŸ¡ HIGH
**Files**: `src/orivus/generator/utils/updatePrisma.ts`

Current issues:
- Doesn't handle existing models with same name gracefully
- No rollback on failure
- Silent when injection fails

Improvements:
- [ ] Detect and warn on model name conflicts
- [ ] Validate schema with `prisma validate` before writing
- [ ] Backup schema before modification
- [ ] Clear error when inverse relation injection fails

---

## ğŸ“… Implementation Order

### Phase 1: Template Testing (Day 1-2)
```
tests/
â””â”€â”€ templates/
    â”œâ”€â”€ prisma-model.test.ts
    â”œâ”€â”€ schema.test.ts
    â”œâ”€â”€ router.test.ts
    â”œâ”€â”€ service.test.ts
    â”œâ”€â”€ test-template.test.ts
    â”œâ”€â”€ ui-form.test.ts
    â””â”€â”€ ui-list.test.ts
```

Each test should:
1. Create a mock ParsedModuleSpec
2. Call the template function
3. Assert the output is correct
4. Test edge cases (optional fields, relations, etc.)

### Phase 2: Spec Validation (Day 2-3)
```
src/orivus/core/
â”œâ”€â”€ spec-validator.ts      # Validation logic
â”œâ”€â”€ validation-errors.ts   # Error code catalog
â””â”€â”€ spec-validator.test.ts # Tests
```

Update CLI to validate before generating:
```typescript
const validation = validateSpec(spec);
if (!validation.valid) {
    console.error("âŒ Spec validation failed:");
    validation.errors.forEach(e => console.error(`   ${e.message}`));
    process.exit(1);
}
```

### Phase 3: CLI Error Handling (Day 3)
- Wrap all operations in try/catch
- Map known errors to human-readable messages
- Add `--verbose` flag for debugging

### Phase 4: E2E Test Command (Day 4)
- Create `e2e-test.ts` CLI command
- Add to package.json scripts
- Test with Blog Platform spec

### Phase 5: Documentation & Release (Day 5)
- Update CHANGELOG.md
- Update README with stability notes
- Create GitHub release v0.4.3

---

## ğŸ§ª Testing Strategy

### Unit Tests (Templates)
```typescript
// tests/templates/prisma-model.test.ts
describe('prisma-model.template', () => {
    it('skips hasMany relations during initial generation', () => {
        const model: ParsedModel = {
            name: 'User',
            fields: [
                { name: 'name', type: 'string', required: true, ... },
                { name: 'posts', type: 'relation', target: 'Post', relationType: 'hasMany', ... }
            ]
        };
        
        const result = generatePrismaModel(model);
        
        expect(result).not.toContain('posts Post[]');
    });
    
    it('generates belongsTo with FK correctly', () => {
        const model: ParsedModel = {
            name: 'Post',
            fields: [
                { name: 'author', type: 'relation', target: 'User', relationType: 'belongsTo', required: true, ... }
            ]
        };
        
        const result = generatePrismaModel(model);
        
        expect(result).toContain('author User @relation');
        expect(result).toContain('authorId String');
    });
});
```

### Integration Tests (E2E)
```typescript
// tests/e2e/blog-generation.test.ts
describe('Blog Platform E2E', () => {
    beforeAll(async () => {
        // Clean state
        await cleanDomainFolder();
        await resetPrismaSchema();
    });
    
    it('generates all modules without errors', async () => {
        const modules = ['1-user', '2-post', '3-comment', '4-tag'];
        
        for (const module of modules) {
            const result = await generateModule(`specs/products/blog/${module}.json`);
            expect(result.success).toBe(true);
        }
    });
    
    it('prisma schema is valid', async () => {
        const result = await exec('npx prisma validate');
        expect(result.exitCode).toBe(0);
    });
    
    it('all module tests pass', async () => {
        const result = await exec('npm run test -- --run');
        expect(result.stdout).toContain('4 passed');
    });
});
```

---

## ğŸ“Š Metrics to Track

| Metric | Current | Target |
|--------|---------|--------|
| Blog Platform first-try success | âŒ 0% | âœ… 100% |
| Template test coverage | 0% | 80%+ |
| Average generation time (4 modules) | ~2min | < 30s |
| CLI errors with clear messages | ~10% | 90%+ |
| Spec validation before generation | âŒ No | âœ… Yes |

---

## ğŸš« Explicitly NOT in Scope

These features are deferred to v0.5+:

- âŒ Orivus Kernel (relation graph engine)
- âŒ Context Protocol (LLM project manifest)
- âŒ NL-to-Spec (natural language generation)
- âŒ manyToMany relation support
- âŒ Auth scaffolding
- âŒ Self-healing tests

**Rationale**: We cannot build advanced features on an unstable foundation.

---

## ğŸ“ Definition of Done

v0.4.3 is ready when:

1. [ ] All template unit tests pass
2. [ ] Spec validation catches common errors
3. [ ] Blog Platform generates with `npm run orivus:e2e-test`
4. [ ] No cryptic error messages in common failure cases
5. [ ] CHANGELOG updated with fixes
6. [ ] Version bumped to 0.4.3

---

## ğŸ Next Steps

1. **Create this file** â†’ `docs/v0.4.3-STABILITY-PLAN.md`
2. **Create template test files** â†’ One per template
3. **Implement spec-validator** â†’ Core validation logic
4. **Add E2E test command** â†’ `orivus:e2e-test`
5. **Test with Blog Platform** â†’ Prove it works
6. **Release v0.4.3** â†’ "The Stability Release"

---

> *"The best framework is one that disappears â€” you describe what you want, and it just works."*
